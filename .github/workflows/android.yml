name: Deploy to Slack (internal test)

on:
  push:
    branches:
      - release

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Set up JDK 11
        uses: actions/setup-java@v1
        with:
          java-version: 11.0.3

      - name: Run yarn install ðŸ› 
        run: yarn install

      - name: Grant execute permission for graldew
        run: cd android && chmod +x ./gradlew

      - name: Build wite Gradlew
        run: cd android && ./gradlew build

      - name: Build AAB
        run: cd android && ./gradlew bundleRelease --stacktrace

      - name: Sign Release
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: ./android/app/build/outputs/bundle/release
          signingKeyBase64: ${{ secrets.SIGNING_KEY }}
          alias: ${{ secrets.ALIAS }} 
          keyStorePassword: ${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword: ${{ secrets.KEY_PASSWORD }}

      # - name: Upload Apk to Slack
      #   env: 
      #     SLACK_TOKEN: ${{ secrets.SLACK_READ_WRITE_TOKEN }}
      #     SLACK_CHANNELS: ${{ secrets.SLACK_CHANNEL_DEPLOY }}
      #     FILE_PATH: '@app/build/outputs/apk/release/app-release.apk'
      #   run: |
      #     cd android
      #     curl https://slack.com/api/files.upload -F token=$SLACK_TOKEN -F channels=$SLACK_CHANNELS -F file=$FILE_PATH
          
      # - name: Post to a Slack channel
      #   id: slack
      #   uses: slackapi/slack-github-action@v1.21.0
      #   with:
      #     # Slack channel id, channel name, or user id to post message.
      #     # See also: https://api.slack.com/methods/chat.postMessage#channels
      #     channel-id: ${{ secrets.SLACK_CHANNEL_DEPLOY }}
      #     # For posting a simple plain text message
      #     slack-message: "APK ë¹Œë“œ ì™„ë£Œ~!ðŸ˜„"
      #   env:
      #     SLACK_BOT_TOKEN: ${{ secrets.SLACK_READ_WRITE_TOKEN }}
          

      - name: Check AAB File
        run: cd ./android/app/build/outputs/bundle/release && ls -al

      - name: Deploy to internal
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.SERVICE_ACCOUNT_JSON }}
          packageName: com.freddy.sampleapp
          releaseFiles: ./android/app/build/outputs/bundle/release/app-release.aab
          track: internal